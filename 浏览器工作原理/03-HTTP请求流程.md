# HTTP请求流程

**HTTP 是一种允许浏览器向服务器获取资源的协议**，是 Web 的基础，通常由浏览器发起请求，用来获取不同类型的文件，例如 HTML 文件、CSS 文件、JavaScript 文件、图片、视频等。

## 浏览器端发起 HTTP 请求流程

### 1.构建请求

浏览器构建请求行信息（`GET /index.html HTTP1.1`），构建好后，浏览器准备发起网络请求

### 2.查找缓存

在真正发起网络请求之前，浏览器会先在浏览器缓存中查询是否有要请求的文件。其中，浏览器缓存是一种在本地保存资源副本，以供下次请求时直接使用的技术。

### 3.准备IP和端口

浏览器**使用 HTTP 协议作为应用层协议**，用来封装请求的文本信息；并**使用 TCP/IP 作传输层协议**将它发到网络上，所以在 HTTP 工作开始之前，浏览器需要通过 TCP 与服务器建立连接。也就是**说 HTTP 的内容是通过 TCP 的传输数据阶段来实现的**

### 4.等待 TCP 队列

Chrome 有个机制，同一个域名同时最多只能建立 6 个 TCP 连接，如果在同一个域名下同时有 10 个请求发生，那么其中 4 个请求会进入排队等待状态，直至进行中的请求完成。

- HTTP 网络请求的第一步是和服务器建立 TCP 连接
- 而建立 TCP 连接的第一步就是需要准备 IP 地址和端口号
- 利用 URL 地址来获取 IP 和端口信息（DNS解析）
- 这样一路推导下来，你会发现在**第一步浏览器会请求 DNS 返回域名对应的 IP**。当然浏览器还提供了 DNS 数据缓存服务，如果某个域名已经解析过了，那么浏览器会缓存解析的结果，以供下次查询时直接使用，这样也会减少一次网络请求。

### 5.建立 TCP 连接

三次握手

### 6.发送 HTTP 请求

- 首先浏览器会向服务器发送**请求行**，它包括了**请求方法、请求 URI（Uniform Resource Identifier）和 HTTP 版本协议**。
- 还要以**请求头**形式发送其他一些信息，把浏览器的一些基础信息告诉服务器

## 服务器端处理 HTTP 请求流程

### 1.返回请求

- 首先服务器会返回**响应行**，包括协议版本和状态码。
- 随后，正如浏览器会随同请求发送请求头一样，服务器也会随同响应向浏览器发送**响应头**。
- 发送完响应头后，服务器就可以继续发送响应体的数据，通常，响应体就包含了 HTML 的实际内容。

### 2.断开连接

- 通常情况下，一旦服务器向客户端返回了请求数据，它就要关闭 TCP 连接。不过如果浏览器或者服务器在其头信息中加入了`Connection:Keep-Alive`。那么 TCP 连接在发送后将仍然保持打开状态，这样浏览器就可以继续通过同一个 TCP 连接发送请求
- 保持 TCP 连接可以省去下次请求时需要建立连接的时间，提升资源加载速度。

### 3.重定向

3xx

## 几个问题

### 为什么很多站点第二次打开速度会很快

- DNS 缓存和页面资源缓存这两块数据是会被浏览器缓存的
- 当服务器返回 HTTP 响应头给浏览器时，浏览器是通过响应头中的 Cache-Control 字段来设置是否缓存该资源。
- `Cache-Control:Max-age=2000`
- 但如果缓存过期了，浏览器则会继续发起网络请求，并且在 HTTP 请求头中带上`If-None-Match:"4f80f-13c-3a1xb12a"`
- 服务器收到请求头后，会根据 If-None-Match 的值来判断请求的资源是否有更新。
  - 如果没有更新，就返回 304 状态码，相当于服务器告诉浏览器：“这个缓存可以继续使用，这次就不重复发送数据给你了。”
  - 如果资源有更新，服务器就直接返回最新资源给浏览器。

### 登录状态是如何保持的

- 利用Cookie
- 服务器响应`Set-Cookie`
- 浏览器携带`Cookie`

![HTTP 请求流程示意图](https://static001.geekbang.org/resource/image/1b/6c/1b49976aca2c700883d48d927f48986c.png)
